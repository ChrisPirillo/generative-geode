<!DOCTYPE html>
<html lang="en"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1CQ4D3VQ3L');
  </script>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
<link rel="preconnect" href="https://www.googletagmanager.com">

<title>Generative Geode: 3D Mineral Lab</title>

<meta name="description" content="Explore and customize procedural 3D geodes with adjustable mineral growth, agate striations, and crystal formations using real-time simulation.">
<meta name="keywords" content="Three.js, Generative Art, Geology, 3D Simulation, Procedural Generation, Crystal Growth, Geode Viewer, Interactive Art">
<meta name="author" content="Chris Pirillo">
<meta name="robots" content="index, follow, max-image-preview:large">
<meta name="theme-color" content="#0f172a">
<meta name="application-name" content="Generative Geode: 3D Mineral Lab">
<meta name="apple-mobile-web-app-title" content="Generative Geode: 3D Mineral Lab">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">

<meta property="og:site_name" content="Chris Pirillo's Arcade">
<meta property="og:type" content="website">
<meta property="og:title" content="Generative Geode: 3D Mineral Lab">
<meta property="og:description" content="Explore and customize procedural 3D geodes with adjustable mineral growth, agate striations, and crystal formations using real-time simulation.">
<meta property="og:url" content="https://arcade.pirillo.com/generative-geode.html">
<meta property="og:image" content="https://arcade.pirillo.com/images/generative-geode.png">
<meta property="og:image:alt" content="Generative Geode: 3D Mineral Lab">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2026-02-26T21:46:53.522Z">
<meta property="article:author" content="Chris Pirillo">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@ChrisPirillo">
<meta name="twitter:creator" content="@ChrisPirillo">
<meta name="twitter:title" content="Generative Geode: 3D Mineral Lab">
<meta name="twitter:description" content="Explore and customize procedural 3D geodes with adjustable mineral growth, agate striations, and crystal formations using real-time simulation.">
<meta name="twitter:image" content="https://arcade.pirillo.com/images/generative-geode.png">
<meta name="twitter:domain" content="arcade.pirillo.com">
<meta name="twitter:url" content="https://arcade.pirillo.com/generative-geode.html">

<link rel="canonical" href="https://arcade.pirillo.com/generative-geode.html">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.json">

<script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Generative Geode: 3D Mineral Lab",
  "description": "Explore and customize procedural 3D geodes with adjustable mineral growth, agate striations, and crystal formations using real-time simulation.",
  "url": "https://arcade.pirillo.com/generative-geode.html",
  "image": "https://arcade.pirillo.com/images/generative-geode.png",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "https://arcade.pirillo.com/images/generative-geode.png"
  },
  "datePublished": "2026-02-26T21:46:53.522Z",
  "dateModified": "2026-02-26T21:46:53.522Z",
  "author": {
    "@type": "Person",
    "name": "Chris Pirillo",
    "url": "https://pirillo.com",
    "sameAs": [
      "https://x.com/ChrisPirillo",
      "https://linkedin.com/in/chrispirillo"
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chris Pirillo",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pirillo.com/logo.png"
    }
  },
  "mainEntity": {
    "@type": "WebApplication",
    "name": "Generative Geode: 3D Mineral Lab",
    "description": "Explore and customize procedural 3D geodes with adjustable mineral growth, agate striations, and crystal formations using real-time simulation.",
    "image": "https://arcade.pirillo.com/images/generative-geode.png",
    "operatingSystem": "Any",
    "applicationCategory": "Simulation",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock"
    },
    "author": {
      "@type": "Person",
      "name": "Chris Pirillo",
      "url": "https://pirillo.com"
    },
    "datePublished": "2026-02-26T21:46:53.522Z",
    "inLanguage": "en-US"
  }
}</script>

<meta charset="UTF-8">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&amp;display=swap" rel="stylesheet">
<style>:root { --bg-color: #050505; }
body { margin: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Inter', sans-serif; user-select: none; -webkit-user-select: none; }
canvas { display: block; width: 100vw; height: 100vh; }
#fade-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; opacity: 0; pointer-events: none; transition: opacity 0.4s ease-in-out; z-index: 100; }
.glass-panel { background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
input[type=range]:focus { outline: none; }
input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: #fff; cursor: pointer; -webkit-appearance: none; margin-top: -6px; }
#settings-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(100%); z-index: 200; }
#settings-panel.open { transform: translateX(0); }
#info-modal { z-index: 300; display: none; }
.action-button { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 16px; border-radius: 8px; transition: all 0.2s; text-align: center; font-size: 13px; color: rgba(255, 255, 255, 0.8); cursor: pointer; display: block; width: 100%; }
.action-button:hover { background: rgba(255, 255, 255, 0.15); color: #fff; transform: translateY(-1px); }</style>
</head>
<body><h1 style="display: none;">Generative Geode: 3D Mineral Lab</h1>

    <div id="fade-overlay"></div>

    <div class="fixed top-6 right-6 z-[150] flex gap-4">
        <button id="menu-toggle" class="w-12 h-12 glass-panel rounded-full flex items-center justify-center text-white hover:bg-white hover:text-black transition-all shadow-lg">
            <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"></line><line x1="4" x2="20" y1="6" y2="6"></line><line x1="4" x2="20" y1="18" y2="18"></line></svg>
        </button>
    </div>

    <aside id="settings-panel" class="fixed top-0 right-0 h-full w-full sm:w-[420px] glass-panel flex flex-col shadow-2xl">
        <header class="flex items-center justify-between px-6 py-5 border-b border-white/10 shrink-0">
            <h2 class="text-white text-sm font-semibold tracking-widest uppercase">Geode Lab</h2>
            <div class="flex items-center gap-4">
                <button id="info-btn" class="text-white/50 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><path d="M12 17h.01"></path></svg>
                </button>
                <button id="close-menu" class="text-white/50 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
                </button>
            </div>
        </header>

        <div id="controls-body" class="flex-grow overflow-y-auto p-6 custom-scrollbar space-y-8">
            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Animation &amp; Scene</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Rotation (Direction/Speed)</span><span id="val-rot">0.5</span></div>
                    <input type="range" id="param-rot-speed" min="-0.5" max="0.5" step="0.05" value="0.25">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Fog Density</span><span id="val-fog">0.008</span></div>
                    <input type="range" id="param-fog-density" min="0" max="0.05" step="0.001" value="0.008">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-xs text-white/70">Auto-Advance</label>
                    <input type="checkbox" id="auto-advance-toggle" class="sr-only peer">
                    <div onclick="document.getElementById('auto-advance-toggle').click()" class="w-10 h-5 bg-white/10 rounded-full peer peer-checked:bg-blue-500 relative transition-all cursor-pointer">
                        <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-all peer-checked:left-6"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Interval (Seconds)</span><span id="val-interval">10</span></div>
                    <input type="range" id="param-advance-interval" min="3" max="60" step="1" value="10">
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Outer Rock</h3>
                <div class="flex justify-between text-xs text-white/70"><span>Rock Color</span><input type="color" id="param-rock-color" value="#444444" class="bg-transparent border-0 w-6 h-6 p-0 cursor-pointer"></div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Opening Width (Max 0.6)</span><span id="val-open">0.55</span></div>
                    <input type="range" id="param-opening" min="0.2" max="0.6" step="0.01" value="0.55">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Cragginess (Max 1.3)</span><span id="val-crag">1.0</span></div>
                    <input type="range" id="param-rock-crag" min="0" max="1.3" step="0.05" value="1.0">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Wall Thickness (Max 1.0)</span><span id="val-thick">0.9</span></div>
                    <input type="range" id="param-thick" min="0.5" max="1.0" step="0.05" value="0.9">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Rim Jaggedness</span><span id="val-jagged">0.12</span></div>
                    <input type="range" id="param-rim-jagged" min="0" max="0.5" step="0.01" value="0.12">
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Mineral Rind (Layers)</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Rind Width</span><span id="val-rind">1.0</span></div>
                    <input type="range" id="param-rind-width" min="0.1" max="2.5" step="0.1" value="1.0">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Striation Contrast</span><span id="val-striate">0.4</span></div>
                    <input type="range" id="param-striation-alpha" min="0.1" max="1.0" step="0.05" value="0.4">
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Drusy Bed (Inner)</h3>
                <div class="flex justify-between text-xs text-white/70"><span>Bed Color</span><input type="color" id="param-inner-color" value="#ffffff" class="bg-transparent border-0 w-6 h-6 p-0 cursor-pointer"></div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Drusy Sparkle</span><span id="val-sparkle">1.5</span></div>
                    <input type="range" id="param-sparkle" min="0" max="5" step="0.1" value="1.5">
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Gem Crystals</h3>
                <div class="flex justify-between text-xs text-white/70"><span>Gem Color</span><input type="color" id="param-crystal-color" value="#9b59b6" class="bg-transparent border-0 w-6 h-6 p-0 cursor-pointer"></div>
                <div class="flex justify-between text-xs text-white/70"><span>Glow Color</span><input type="color" id="param-glow-color" value="#8e44ad" class="bg-transparent border-0 w-6 h-6 p-0 cursor-pointer"></div>
                
                <div class="space-y-4 pt-2">
                    <p class="text-[9px] uppercase tracking-widest text-white/40">Transparency Mix (Weighted)</p>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] text-white/50"><span>Clear Ratio</span><span id="val-clear-mix">0.6</span></div>
                        <input type="range" id="param-clear-ratio" min="0" max="1" step="0.05" value="0.6">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] text-white/50"><span>Milky Ratio</span><span id="val-milky-mix">0.3</span></div>
                        <input type="range" id="param-milky-ratio" min="0" max="1" step="0.05" value="0.3">
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-[10px] text-white/50"><span>Opaque Ratio</span><span id="val-opaque-mix">0.1</span></div>
                        <input type="range" id="param-opaque-ratio" min="0" max="1" step="0.05" value="0.1">
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Density</span><span id="val-density">0.55</span></div>
                    <input type="range" id="param-density" min="0.1" max="1.0" step="0.01" value="0.55">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Max Crystal Height</span><span id="val-max-h">0.85</span></div>
                    <input type="range" id="param-max-h" min="0.1" max="1.0" step="0.01" value="0.85">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Master Scale</span><span id="val-scale">0.6</span></div>
                    <input type="range" id="param-scale" min="0.1" max="2.0" step="0.05" value="0.6">
                </div>
            </section>

            <section class="space-y-4">
                <h3 class="text-[10px] uppercase tracking-widest text-white/30 border-b border-white/5 pb-2">Atmosphere</h3>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Bloom Intensity</span><span id="val-bloom">0.7</span></div>
                    <input type="range" id="param-bloom-strength" min="0" max="3" step="0.1" value="0.7">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] text-white/50"><span>Key Light</span><span id="val-light">4.0</span></div>
                    <input type="range" id="param-light-intensity" min="0" max="10" step="0.1" value="4.0">
                </div>
            </section>

            <section class="pt-4 grid grid-cols-1 gap-3">
                <button id="btn-export-settings" class="action-button">Export Settings JSON</button>
                <button id="btn-import-settings" class="action-button">Import Settings JSON</button>
                <input type="file" id="import-input" class="hidden" accept=".json">
            </section>
        </div>

        <footer class="p-6 border-t border-white/10 space-y-3 shrink-0">
            <button id="btn-randomize" class="w-full py-3 bg-white text-black font-semibold text-[10px] uppercase tracking-widest rounded-full hover:bg-white/90 transition-all shadow-lg">Randomize Specimen</button>
            <div class="grid grid-cols-2 gap-3">
                <button id="btn-reset" class="py-2 bg-white/5 text-white/70 text-[10px] uppercase tracking-widest rounded-full hover:bg-white/10 border border-white/10">Reset Defaults</button>
                <button id="btn-wallpaper" class="py-2 bg-white/5 text-white/70 text-[10px] uppercase tracking-widest rounded-full hover:bg-white/10 border border-white/10">Export 4K</button>
            </div>
        </footer>
    </aside>

    <div id="info-modal" class="fixed inset-0 flex items-center justify-center p-6 bg-black/80 backdrop-blur-xl">
        <div class="glass-panel w-full max-w-md p-10 rounded-3xl relative shadow-2xl overflow-hidden border-white/20">
            <button id="close-info" class="absolute top-6 right-6 text-white/30 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-6 tracking-tight">Generative Geode</h2>
            <div class="space-y-6 text-sm text-white/60 leading-relaxed">
                <p>A procedural study of mineral growth, agate striation, and geological formation. Every specimen is computed from unique noise seeds.</p>
                
                <div class="grid grid-cols-1 gap-2 pt-2">
                    <a href="https://arcade.pirillo.com/" target="_blank" class="action-button font-semibold bg-white/10 text-white">Explore More Apps</a>
                    <a href="https://chris.pirillo.com/" target="_blank" class="action-button">Follow Chris Pirillo</a>
                    <a href="https://ctrlaltcreate.live/" target="_blank" class="action-button">Make Your Own Apps</a>
                    <a href="https://www.paypal.com/donate/?hosted_button_id=UMWCDWGVXVHZU" target="_blank" class="action-button border-blue-500/30 bg-blue-500/20 text-blue-300">Donate via PayPal</a>
                    <a href="https://patreon.com/ChrisPirillo" target="_blank" class="action-button border-orange-500/30 bg-orange-500/20 text-orange-300">Support on Patreon</a>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        class SimplexNoise {
            constructor(r=Math.random){this.p=new Uint8Array(256),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(let e=0;e<256;e++)this.p[e]=e;for(let e=0;e<256;e++){let t=e+Math.floor(r()* (256-e)),n=this.p[e];this.p[e]=this.p[t],this.p[t]=n}for(let e=0;e<512;e++)this.perm[e]=this.p[255&e],this.permMod12[e]=this.perm[e]%12}
            noise3D(r,e,t){let n=this.permMod12,o=this.perm,a=.333333333*(r+e+t),i=Math.floor(r+a),f=Math.floor(e+a),s=Math.floor(t+a),u=.166666667*(i+f+s),l=r-(i-u),h=e-(f-u),p=t-(s-u),M,d,c,m,y,w;l>=h?h>=p?(M=1,d=0,c=0,m=1,y=1,w=0):l>=p?(M=1,d=0,c=0,m=1,y=0,w=1):(M=0,d=0,c=1,m=1,y=0,w=1):h<p?(M=0,d=0,c=1,m=0,y=1,w=1):l<p?(M=0,d=0,c=1,m=0,y=1,w=1):(M=0,d=1,c=0,m=1,y=1,w=0);let v=l-M+.166666667,A=h-d+.166666667,g=p-c+.166666667,x=l-m+.333333333,b=h-y+.333333333,D=p-w+.333333333,U=l-1+.5,q=h-1+.5,C=p-1+.5,I=255&i,P=255&f,S=255&s,T=.6-l*l-h*h-p*p;let F=0;if(T<0)F=0;else{T*=T;let r=n[I+o[P+o[S]]];F=T*T*(12==r?l+h:13==r?l:14==r?h:0==r?l+h:1==r?l-h:2==r?l+p:3==r?l-p:4==r?h+p:5==r?h-p:6==r?p+l:7==r?p-l:8==r?p+h:9==r?p-h:11==r?l:0)}let k=.6-v*v-A*A-g*g;let B=0;if(k<0)B=0;else{k*=k;let r=n[I+M+o[P+d+o[S+c]]];B=k*k*(12==r?v+A:13==r?v:14==r?A:0==r?v+A:1==r?v-A:2==r?v+g:3==r?v-g:4==r?A+g:5==r?A-g:6==r?g+v:7==r?g-v:8==r?g+A:9==r?g-A:11==r?v:0)}let E=.6-x*x-b*b-D*D;let G=0;if(E<0)G=0;else{E*=E;let r=n[I+m+o[P+y+o[S+w]]];G=E*E*(12==r?x+b:13==r?x:14==r?b:0==r?x+b:1==r?x-b:2==r?x+D:3==r?x-D:4==r?b+D:5==r?b-D:6==r?D+x:7==r?D-x:8==r?D+b:9==r?D-b:11==r?x:0)}let H=.6-U*U-q*q-C*C;let J=0;if(H<0)J=0;else{H*=H;let r=n[I+1+o[P+1+o[S+1]]];J=H*H*(12==r?U+q:13==r?U:14==r?q:0==r?U+q:1==r?U-q:2==r?U+C:3==r?U-C:4==r?q+C:5==r?q-C:6==r?C+U:7==r?C-U:8==r?C+q:9==r?C-q:11==r?U:0)}return 32*(F+B+G+J)}
        }

        let state = {
            seed: Math.random() * 1000,
            rockColor: "#444444",
            rockRoughness: 0.95,
            rockCrag: 1.0,
            crystalColor: "#9b59b6",
            glowColor: "#8e44ad",
            innerColor: "#ffffff",
            density: 0.55,
            scale: 0.6,
            bloomStrength: 0.7,
            lightIntensity: 4.0,
            autoAdvance: false,
            advanceInterval: 10,
            rotSpeed: 0.25,
            opening: 0.55,
            shellThick: 0.9,
            drusySparkle: 1.5,
            rindWidth: 1.0,
            rimJaggedness: 0.12,
            striationAlpha: 0.4,
            maxH: 0.85,
            clearRatio: 0.6,
            milkyRatio: 0.3,
            opaqueRatio: 0.1,
            fogDensity: 0.008
        };

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 9);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        scene.add(new THREE.HemisphereLight(0xffffff, 0x111111, 0.3));
        const mainLight = new THREE.DirectionalLight(0xffffff, state.lightIntensity);
        mainLight.position.set(5, 5, 8); 
        scene.add(mainLight);
        const backLight = new THREE.DirectionalLight(0xffffff, 1.8);
        backLight.position.set(-5, -2, -10);
        scene.add(backLight);

        let currentGeodeGroup = null;
        let lastAdvanceTime = Date.now();

        function createStoneTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = state.rockColor;
            ctx.fillRect(0,0,1024,1024);
            for(let i=0; i<300; i++) {
                const x = Math.random() * 1024; const y = Math.random() * 1024;
                const r = 40 + Math.random() * 120;
                const v = Math.random() * 40 - 20;
                const col = new THREE.Color(state.rockColor).offsetHSL(0, 0, v/100);
                const grd = ctx.createRadialGradient(x, y, 0, x, y, r);
                grd.addColorStop(0, `rgba(${col.r*255},${col.g*255},${col.b*255}, 0.6)`);
                grd.addColorStop(1, `rgba(${col.r*255},${col.g*255},${col.b*255}, 0)`);
                ctx.fillStyle = grd; ctx.fillRect(x-r, y-r, r*2, r*2);
            }
            for(let i=0; i<200000; i++) {
                const v = Math.random() > 0.5 ? 200 : 50;
                ctx.fillStyle = `rgba(${v},${v},${v}, 0.06)`;
                ctx.fillRect(Math.random()*1024, Math.random()*1024, 1, 1);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        function createStriatedTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 1024; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = state.rockColor;
            ctx.fillRect(0,0,1024,128);
            const colors = [state.rockColor, "#ffffff", state.crystalColor, "#222222"];
            for(let i=0; i<150; i++) {
                const x = Math.random() * 1024;
                const w = 1 + Math.random() * 25;
                const col = new THREE.Color(colors[Math.floor(Math.random() * colors.length)]);
                ctx.globalAlpha = state.striationAlpha * (0.4 + Math.random() * 0.6);
                ctx.fillStyle = `#${col.getHexString()}`;
                ctx.fillRect(x, 0, w, 128);
            }
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        function generateGeode() {
            if(currentGeodeGroup) {
                scene.remove(currentGeodeGroup);
                currentGeodeGroup.traverse(c => {
                    if(c.geometry) c.geometry.dispose();
                    if(c.material) {
                        if(Array.isArray(c.material)) c.material.forEach(m => m.dispose());
                        else c.material.dispose();
                    }
                });
            }

            scene.fog = new THREE.FogExp2(0x050505, state.fogDensity);

            const noise = new SimplexNoise(() => {
                let s = state.seed;
                return () => (s = (s * 16807) % 2147483647) / 2147483647;
            });

            const group = new THREE.Group();
            const thetaLen = Math.PI * state.opening; 
            const baseGeo = new THREE.SphereGeometry(1, 160, 160, 0, Math.PI * 2, 0, thetaLen);
            baseGeo.rotateX(-Math.PI / 2);

            const posAttr = baseGeo.attributes.position;
            const count = posAttr.count;
            const v3 = new THREE.Vector3();
            const crystalInstances = Array(3).fill(null).map(() => Array(3).fill(null).map(() => []));
            const rimVerticesOuter = [];
            const rimVerticesInner = [];

            for(let i=0; i<count; i++) {
                v3.fromBufferAttribute(posAttr, i);
                const dir = v3.clone().normalize(); 
                const nx = dir.x + state.seed;
                const ny = dir.y + state.seed;
                const nz = dir.z + state.seed;

                const lN = (noise.noise3D(nx*0.4, ny*0.4, nz*0.4) * 0.5);
                const mN = (noise.noise3D(nx*2.2, ny*2.2, nz*2.2) * 0.15 * state.rockCrag);
                const fN = (noise.noise3D(nx*8, ny*8, nz*8) * 0.03 * state.rockCrag);
                const outerRadius = 2.0 + ((lN + mN + fN) * state.shellThick);
                
                const angleFromBack = dir.angleTo(new THREE.Vector3(0,0,-1));
                const distFromRim = Math.max(0, thetaLen - angleFromBack);
                const rimJitter = noise.noise3D(dir.x*4+state.seed, dir.y*4+state.seed, dir.z*4+state.seed) * state.rimJaggedness;
                const thicknessFade = THREE.MathUtils.smoothstep(distFromRim + rimJitter, 0.0, 0.18);

                const posOuter = dir.clone().multiplyScalar(outerRadius);
                posAttr.setXYZ(i, posOuter.x, posOuter.y, posOuter.z);
                
                const posInner = posOuter.clone().multiplyScalar(0.78);
                const bedNoise = Math.abs(noise.noise3D(dir.x*6+state.seed, dir.y*6+state.seed, dir.z*6+state.seed)) * 0.22;
                posInner.addScaledVector(dir, -bedNoise * thicknessFade);

                if (distFromRim < 0.005) {
                    rimVerticesOuter.push(posOuter.clone());
                    rimVerticesInner.push(posInner.clone());
                }

                if (thicknessFade > 0.03 && Math.random() > (1.0 - state.density)) { 
                    const geoType = Math.floor(Math.random() * 3);
                    
                    const totalRatio = state.clearRatio + state.milkyRatio + state.opaqueRatio;
                    const rValue = Math.random() * totalRatio;
                    let matType = 2; 
                    if (rValue < state.clearRatio) matType = 0;
                    else if (rValue < state.clearRatio + state.milkyRatio) matType = 1;

                    const inward = new THREE.Vector3(0,0,0).sub(posInner).normalize();
                    const chaos = new THREE.Vector3(Math.random()-.5, Math.random()-.5, Math.random()-.5).multiplyScalar(0.7);
                    const norm = inward.add(chaos).normalize();
                    const sizeVar = Math.pow(Math.random(), 2); 
                    const baseSize = (0.2 + sizeVar * 1.8) * state.scale;
                    const blockiness = Math.random(); 
                    const girth = (0.4 + blockiness * 0.6) * baseSize * 0.4;
                    const height = Math.min((0.4 + (1.0 - blockiness) * 0.6) * baseSize, (outerRadius - posInner.length()) * state.maxH);
                    crystalInstances[geoType][matType].push({ pos: posInner.clone(), norm, h: height, g: girth });
                }
            }
            baseGeo.computeVertexNormals();

            const stoneTex = createStoneTexture();
            const rockMat = new THREE.MeshStandardMaterial({
                color: state.rockColor,
                map: stoneTex,
                bumpMap: stoneTex,
                bumpScale: 0.15 * state.rockCrag,
                roughness: state.rockRoughness,
                side: THREE.FrontSide
            });
            group.add(new THREE.Mesh(baseGeo, rockMat));

            const rindTexture = createStriatedTexture();
            const rindMat = new THREE.MeshStandardMaterial({ map: rindTexture, roughness: 0.2, metalness: 0.1, side: THREE.DoubleSide });
            const rindGeo = new THREE.BufferGeometry();
            const rindPoints = []; const rindUVs = [];
            for(let i=0; i<rimVerticesOuter.length; i++) {
                const iNext = (i + 1) % rimVerticesOuter.length;
                const vO1 = rimVerticesOuter[i]; const vI1 = rimVerticesInner[i];
                const vO2 = rimVerticesOuter[iNext]; const vI2 = rimVerticesInner[iNext];
                rindPoints.push(vO1.x, vO1.y, vO1.z); rindUVs.push(0, 0);
                rindPoints.push(vI1.x, vI1.y, vI1.z); rindUVs.push(state.rindWidth, 0);
                rindPoints.push(vO2.x, vO2.y, vO2.z); rindUVs.push(0, 1);
                rindPoints.push(vI1.x, vI1.y, vI1.z); rindUVs.push(state.rindWidth, 0);
                rindPoints.push(vI2.x, vI2.y, vI2.z); rindUVs.push(state.rindWidth, 1);
                rindPoints.push(vO2.x, vO2.y, vO2.z); rindUVs.push(0, 1);
            }
            rindGeo.setAttribute('position', new THREE.Float32BufferAttribute(rindPoints, 3));
            rindGeo.setAttribute('uv', new THREE.Float32BufferAttribute(rindUVs, 2));
            rindGeo.computeVertexNormals();
            group.add(new THREE.Mesh(rindGeo, rindMat));

            const drusyMat = new THREE.MeshStandardMaterial({
                color: state.innerColor,
                roughness: 0.1,
                metalness: 0.3 * state.drusySparkle,
                side: THREE.BackSide 
            });
            const innerGeo = baseGeo.clone();
            const innerPos = innerGeo.attributes.position;
            for(let i=0; i<innerPos.count; i++) {
                v3.fromBufferAttribute(innerPos, i);
                const dir = v3.clone().normalize();
                const angleFromBack = dir.angleTo(new THREE.Vector3(0,0,-1));
                const distFromRim = Math.max(0, thetaLen - angleFromBack);
                const thicknessFade = THREE.MathUtils.smoothstep(distFromRim + (noise.noise3D(dir.x*4, dir.y*4, dir.z*4)*state.rimJaggedness), 0.0, 0.18);
                v3.multiplyScalar(0.78);
                v3.addScaledVector(dir, -Math.abs(noise.noise3D(dir.x*6+state.seed, dir.y*6+state.seed, dir.z*6+state.seed)) * 0.22 * thicknessFade);
                innerPos.setXYZ(i, v3.x, v3.y, v3.z);
            }
            innerGeo.computeVertexNormals();
            group.add(new THREE.Mesh(innerGeo, drusyMat));

            const gemMats = [
                new THREE.MeshPhysicalMaterial({ color: state.crystalColor, roughness: 0.01, transmission: 0.98, thickness: 1.0, flatShading: true, ior: 1.7 }),
                new THREE.MeshPhysicalMaterial({ color: state.crystalColor, roughness: 0.2, transmission: 0.45, flatShading: true, ior: 1.5 }),
                new THREE.MeshStandardMaterial({ color: state.crystalColor, roughness: 0.6, emissive: state.glowColor, emissiveIntensity: 0.1 })
            ];
            const geometries = [
                new THREE.CylinderGeometry(0.2, 0.35, 1.0, 6, 1).translate(0, 0.5, 0),
                new THREE.CylinderGeometry(0.15, 0.25, 0.8, 4, 1).translate(0, 0.4, 0),
                new THREE.CylinderGeometry(0.3, 0.45, 0.6, 5, 1).translate(0, 0.3, 0)
            ];
            const dummy = new THREE.Object3D();
            geometries.forEach((geo, gIdx) => {
                gemMats.forEach((mat, mIdx) => {
                    const data = crystalInstances[gIdx][mIdx];
                    if (data.length === 0) return;
                    const im = new THREE.InstancedMesh(geo, mat, data.length);
                    data.forEach((d, i) => {
                        dummy.position.copy(d.pos); dummy.lookAt(d.pos.clone().add(d.norm));
                        dummy.rotateX(Math.PI / 2); dummy.rotateY(Math.random() * Math.PI);
                        dummy.scale.set(d.g, d.h, d.g); dummy.updateMatrix();
                        im.setMatrixAt(i, dummy.matrix);
                    });
                    group.add(im);
                });
            });

            group.rotation.x = 0.4; group.rotation.y = 0.2;
            currentGeodeGroup = group;
            scene.add(group);
            mainLight.intensity = state.lightIntensity;
            bloomPass.strength = state.bloomStrength;
            controls.autoRotate = state.rotSpeed !== 0;
            controls.autoRotateSpeed = state.rotSpeed;
        }

        // Helper to randomize ALL slider-based and color-based settings
        function randomizeAllSettings() {
            state.seed = Math.random() * 10000;
            state.rockColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            state.crystalColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            state.glowColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
            state.innerColor = "#ffffff";
            
            // Randomize visual/structural parameters within their UI-defined ranges
            // Speed cap 0.5, support bidirectional direction (-0.5 to 0.5)
            state.rotSpeed = Number((Math.random() * 1.0 - 0.5).toFixed(2)); 
            state.opening = Number((0.2 + Math.random() * 0.4).toFixed(2));
            state.shellThick = Number((0.5 + Math.random() * 0.5).toFixed(2));
            state.rockCrag = Number((Math.random() * 1.3).toFixed(2));
            state.drusySparkle = Number((Math.random() * 4.0).toFixed(1));
            state.density = Number((0.2 + Math.random() * 0.8).toFixed(2));
            state.scale = Number((0.3 + Math.random() * 1.5).toFixed(2));
            state.bloomStrength = Number((0.2 + Math.random() * 1.8).toFixed(1));
            state.lightIntensity = Number((1.5 + Math.random() * 7.0).toFixed(1));
            state.rindWidth = Number((0.2 + Math.random() * 2.0).toFixed(1));
            state.rimJaggedness = Number((Math.random() * 0.4).toFixed(2));
            state.striationAlpha = Number((0.1 + Math.random() * 0.9).toFixed(2));
            state.maxH = Number((0.3 + Math.random() * 0.7).toFixed(2));
            state.fogDensity = Number((0.001 + Math.random() * 0.02).toFixed(3));
            
            // Weighted randomization for crystal types
            const sum = Math.random() + Math.random() + Math.random();
            state.clearRatio = Number((Math.random() / sum).toFixed(2));
            state.milkyRatio = Number((Math.random() / sum).toFixed(2));
            state.opaqueRatio = Number((Math.random() / sum).toFixed(2));
        }

        async function triggerRandomization() {
            const overlay = document.getElementById('fade-overlay');
            overlay.style.opacity = 1;
            await new Promise(r => setTimeout(r, 400));
            
            randomizeAllSettings();
            
            updateUIFromState();
            generateGeode();
            overlay.style.opacity = 0;
            lastAdvanceTime = Date.now();
        }

        function updateUIFromState() {
            const mappings = {
                'param-rock-color': 'rockColor', 'param-crystal-color': 'crystalColor',
                'param-glow-color': 'glowColor', 'param-rot-speed': 'rotSpeed',
                'param-opening': 'opening', 'param-thick': 'shellThick',
                'param-rock-rough': 'rockRoughness', 'param-rock-crag': 'rockCrag',
                'param-sparkle': 'drusySparkle', 'param-density': 'density',
                'param-scale': 'scale', 'param-bloom-strength': 'bloomStrength',
                'param-light-intensity': 'lightIntensity', 'param-advance-interval': 'advanceInterval',
                'param-rind-width': 'rindWidth', 'param-rim-jagged': 'rimJaggedness',
                'param-striation-alpha': 'striationAlpha', 'param-inner-color': 'innerColor',
                'param-fog-density': 'fogDensity', 'param-max-h': 'maxH',
                'param-clear-ratio': 'clearRatio', 'param-milky-ratio': 'milkyRatio', 'param-opaque-ratio': 'opaqueRatio'
            };
            for(let [id, key] of Object.entries(mappings)) {
                const el = document.getElementById(id);
                if(el) el.value = state[key];
            }
            const toggle = document.getElementById('auto-advance-toggle');
            if(toggle) toggle.checked = state.autoAdvance;

            const valMap = {
                'val-rot': state.rotSpeed, 'val-open': state.opening, 'val-thick': state.shellThick,
                'val-rock-rough': state.rockRoughness, 'val-crag': state.rockCrag, 'val-sparkle': state.drusySparkle,
                'val-density': state.density, 'val-scale': state.scale, 'val-bloom': state.bloomStrength,
                'val-light': state.lightIntensity, 'val-interval': state.advanceInterval, 'val-rind': state.rindWidth,
                'val-jagged': state.rimJaggedness, 'val-striate': state.striationAlpha, 'val-fog': state.fogDensity,
                'val-max-h': state.maxH, 'val-clear-mix': state.clearRatio, 'val-milky-mix': state.milkyRatio, 'val-opaque-mix': state.opaqueRatio
            };
            for(let [id, val] of Object.entries(valMap)) {
                const el = document.getElementById(id);
                if(el) el.innerText = val;
            }
        }

        let isMenuOpen = false, isModalOpen = false, mouseDownPos = { x: 0, y: 0 };
        const toggleMenu = (f) => { isMenuOpen = f !== undefined ? f : !isMenuOpen; document.getElementById('settings-panel').classList.toggle('open', isMenuOpen); };
        const toggleModal = (f) => { isModalOpen = f !== undefined ? f : !isModalOpen; document.getElementById('info-modal').style.display = isModalOpen ? 'flex' : 'none'; };

let menuStateOnDown = false;
        renderer.domElement.addEventListener('mousedown', (e) => {
            mouseDownPos = { x: e.clientX, y: e.clientY };
            menuStateOnDown = isMenuOpen || isModalOpen;
        });
        renderer.domElement.addEventListener('mouseup', (e) => {
            if (menuStateOnDown || isMenuOpen || isModalOpen) return;
            const dist = Math.sqrt(Math.pow(e.clientX - mouseDownPos.x, 2) + Math.pow(e.clientY - mouseDownPos.y, 2));
            if (dist < 5) triggerRandomization();
        });

        window.addEventListener('mousedown', (e) => { if (isMenuOpen && !document.getElementById('settings-panel').contains(e.target) && !document.getElementById('menu-toggle').contains(e.target)) toggleMenu(false); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (isModalOpen) toggleModal(false); else if (isMenuOpen) toggleMenu(false); } });

        document.getElementById('menu-toggle').onclick = () => toggleMenu();
        document.getElementById('close-menu').onclick = () => toggleMenu(false);
        document.getElementById('info-btn').onclick = () => toggleModal(true);
        document.getElementById('close-info').onclick = () => toggleModal(false);
        document.getElementById('btn-randomize').onclick = triggerRandomization;
        document.getElementById('btn-reset').onclick = () => {
            state = { ...state, seed: Math.random()*1000, rockColor: "#444444", crystalColor: "#9b59b6", glowColor: "#8e44ad", rotSpeed: 0.25, opening: 0.55, shellThick: 0.9, rockCrag: 1.0, drusySparkle: 1.5, density: 0.55, scale: 0.6, bloomStrength: 0.7, lightIntensity: 4.0, rindWidth: 1.0, striationAlpha: 0.4, fogDensity: 0.008, maxH: 0.85, clearRatio: 0.6, milkyRatio: 0.3, opaqueRatio: 0.1 };
            updateUIFromState(); generateGeode();
        };

        const bindInput = (id, key, valId, isFloat = true) => {
            const el = document.getElementById(id); if (!el) return;
            el.oninput = () => { state[key] = isFloat ? parseFloat(el.value) : el.value; if (valId) { const vEl = document.getElementById(valId); if (vEl) vEl.innerText = el.value; } generateGeode(); };
        };
        const sliders = [
            ['param-rot-speed', 'rotSpeed', 'val-rot'], ['param-opening', 'opening', 'val-open'],
            ['param-thick', 'shellThick', 'val-thick'], ['param-rock-rough', 'rockRoughness', 'val-rock-rough'],
            ['param-rock-crag', 'rockCrag', 'val-crag'], ['param-sparkle', 'drusySparkle', 'val-sparkle'],
            ['param-density', 'density', 'val-density'], ['param-scale', 'scale', 'val-scale'],
            ['param-bloom-strength', 'bloomStrength', 'val-bloom'], ['param-light-intensity', 'lightIntensity', 'val-light'],
            ['param-advance-interval', 'advanceInterval', 'val-interval'], ['param-rind-width', 'rindWidth', 'val-rind'],
            ['param-rim-jagged', 'rimJaggedness', 'val-jagged'], ['param-striation-alpha', 'striationAlpha', 'val-striate'],
            ['param-fog-density', 'fogDensity', 'val-fog'], ['param-max-h', 'maxH', 'val-max-h'],
            ['param-clear-ratio', 'clearRatio', 'val-clear-mix'], ['param-milky-ratio', 'milkyRatio', 'val-milky-mix'], ['param-opaque-ratio', 'opaqueRatio', 'val-opaque-mix']
        ];
        sliders.forEach(s => bindInput(s[0], s[1], s[2]));
        
        ['param-rock-color', 'param-crystal-color', 'param-glow-color', 'param-inner-color'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.onchange = (e) => { 
                    const key = id.replace('param-', '').replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                    state[key] = e.target.value; 
                    generateGeode(); 
                };
            }
        });

        document.getElementById('auto-advance-toggle').onchange = (e) => { state.autoAdvance = e.target.checked; lastAdvanceTime = Date.now(); };

        document.getElementById('btn-wallpaper').onclick = () => {
            const w = 3840, h = 2160, origAspect = camera.aspect;
            camera.aspect = w / h; camera.updateProjectionMatrix();
            renderer.setSize(w, h); composer.setSize(w, h);
            composer.render();
            const link = document.createElement('a'); link.download = `Geode_4K_${Math.floor(state.seed)}.png`;
            link.href = renderer.domElement.toDataURL('image/png'); link.click();
            camera.aspect = origAspect; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
        };

        document.getElementById('btn-export-settings').onclick = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `Geode_Settings_${Date.now()}.json`); dl.click();
        };

        document.getElementById('btn-import-settings').onclick = () => document.getElementById('import-input').click();
        document.getElementById('import-input').onchange = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader(); r.onload = (re) => { try { state = { ...state, ...JSON.parse(re.target.result) }; updateUIFromState(); generateGeode(); } catch(err) { console.error(err); } };
            r.readAsText(file);
        };

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            if (state.autoAdvance && Date.now() - lastAdvanceTime > state.advanceInterval * 1000) triggerRandomization();
            composer.render();
        }
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); });
        
        // Randomize all settings right at the start
        randomizeAllSettings();
        updateUIFromState(); 
        generateGeode(); 
        animate();
    </script>

</body></html>